<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background: #ffffff; color: #111111; }
        p { color: #111111; }

        .container { max-width: 980px; margin: 0 auto; padding: 24px 16px 56px; }
        .section { margin-top: 28px; }
        .section h2 { margin: 0 0 12px; }
        h1 { margin: 0 0 12px; }

        .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        @media (min-width: 800px) {
            .grid { grid-template-columns: 1fr 1fr; }
        }

        .card { border: 1px solid #e5e7eb; background: #ffffff; padding: 16px; border-radius: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
        .product-card { border: 1px solid #e5e7eb; padding: 16px; margin: 0; border-radius: 10px; background: #ffffff; }
        .product-card h3 { margin-top: 0; }
        input[type="number"] { width: 60px; padding: 5px; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .order-card { border: 1px solid #e5e7eb; padding: 16px; margin: 0; border-radius: 10px; background-color: #ffffff; }
        .order-card h3 { margin: 0 0 6px; color: #111111; }
        .order-card p, .order-card li { color: #111111; }
        .order-card ul { margin: 10px 0; }
        .order-card li { margin: 5px 0; }
        #cart-total { font-size: 18px; font-weight: bold; margin: 10px 0; }
        .qty-row { display: flex; align-items: center; gap: 12px; margin-top: 8px; }
        .muted { color: #666; font-size: 12px; }

        .alert { padding: 14px 14px; margin: 0 0 12px; border-radius: 10px; color: #111111; }
        .alert p { margin: 8px 0 0 0; color: #111111; }
        .alert-success { background-color: #e7f5ff; border: 1px solid #74c0fc; }
        .alert-warn { background-color: #fff3cd; border: 1px solid #ffc107; }

        .checkout-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
        .checkout-row button { min-width: 120px; }
    </style>
</head>
<body>
    <div class="container">
    <h1>Welcome to the Shop</h1>
    
    {% if request.GET.success %}
    <div class="alert alert-success">
        <strong>Payment received</strong>
        <p>Your payment was completed on Stripe. This page will update once the Stripe webhook confirms the order as PAID.</p>
    </div>
    {% endif %}

    {% if request.GET.canceled %}
    <div class="alert alert-warn">
        <strong>Checkout canceled</strong>
        <p>No payment was completed.</p>
    </div>
    {% endif %}

    {% if demo_mode %}
    <div class="alert alert-warn">
        <strong>⚠️ Demo Mode Active</strong>
        <p>Stripe API keys are not configured. Running in demo mode (fallback) - orders will be marked PAID immediately without Stripe.</p>
        <p><small>To enable real Stripe checkout, set environment variables: STRIPE_PUBLISHABLE_KEY, STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET</small></p>
    </div>
    {% endif %}
    
    <!-- Product list section -->
    <section id="products" class="section">
        <h2>Products (3 fixed items)</h2>
        <div class="grid">
        {% for product in products %}
            <div class="product-card">
                <h3>{{ product.name }}</h3>
                <p><strong>Price:</strong> ${{ product.price_display }}</p>
                <div class="qty-row">
                    <label for="qty-{{ product.id }}"><strong>Quantity</strong></label>
                    <input
                        type="number"
                        id="qty-{{ product.id }}"
                        class="quantity-input"
                        data-product-id="{{ product.id }}"
                        data-price-cents="{{ product.price_cents }}"
                        min="0"
                        value="0"
                    >
                    <span class="muted">Enter 0–99</span>
                </div>
            </div>
        {% empty %}
            <p>No products available.</p>
        {% endfor %}
        </div>
    </section>
    
    <!-- Checkout section -->
    <section id="checkout" class="section">
        <h2>Checkout</h2>
        <div class="card">
            <div class="checkout-row">
                <div id="cart-total">Total: $0.00</div>
                <button id="checkout-button" onclick="checkout()">Buy</button>
            </div>
            <div class="muted" style="margin-top: 8px;">
                Orders are finalized only via Stripe webhook in real mode (never via redirect).
            </div>
            {% csrf_token %}
        </div>
    </section>
    
    <!-- Orders history section -->
    <section id="orders" class="section">
        <h2>My Orders</h2>
        {% if orders %}
            <div class="grid">
            {% for order in orders %}
                <div class="order-card">
                    <h3>Order #{{ order.id }}</h3>
                    <p><strong>Status:</strong> {{ order.status }}</p>
                    <p><strong>Total:</strong> ${{ order.total_display }}</p>
                    <p><strong>Created:</strong> {{ order.created_at|date:"Y-m-d H:i" }}</p>
                    <h4>Items:</h4>
                    <ul>
                        {% for item in order.items.all %}
                            <li>{{ item.product.name }} × {{ item.quantity }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endfor %}
            </div>
        {% else %}
            <p>No orders yet.</p>
        {% endif %}
    </section>
    
    <script>
        const stripeConfigured = {{ stripe_configured|lower }};
        const demoMode = {{ demo_mode|lower }};
        const stripe = stripeConfigured ? Stripe('{{ stripe_public_key }}') : null;

        function clampInt(value, min, max) {
            const n = parseInt(value, 10);
            if (Number.isNaN(n)) return min;
            return Math.max(min, Math.min(max, n));
        }

        function computeTotalCents() {
            const inputs = document.querySelectorAll('.quantity-input');
            let totalCents = 0;
            inputs.forEach((input) => {
                const qty = clampInt(input.value, 0, 99);
                input.value = qty;
                const priceCents = parseInt(input.dataset.priceCents, 10);
                totalCents += priceCents * qty;
            });
            return totalCents;
        }

        function renderTotal() {
            const totalCents = computeTotalCents();
            document.getElementById('cart-total').textContent = `Total: $${(totalCents / 100).toFixed(2)}`;
        }

        document.querySelectorAll('.quantity-input').forEach((input) => {
            input.addEventListener('input', renderTotal);
            input.addEventListener('change', renderTotal);
        });
        renderTotal();
        
        // After Stripe redirects back, poll the server for webhook-finalized status.
        // This avoids repeated full-page reload flicker.
        (function pollForPaidAfterSuccess() {
            if (demoMode || !stripeConfigured) return;
            const params = new URLSearchParams(window.location.search);
            if (!params.has('success')) return;
            const sessionId = params.get('session_id');
            if (!sessionId) return;

            let attempts = 0;
            const maxAttempts = 30; // ~45s @ 1500ms

            async function tick() {
                attempts += 1;
                try {
                    const resp = await fetch(`/order-status/?session_id=${encodeURIComponent(sessionId)}`, {
                        headers: { 'Accept': 'application/json' },
                    });
                    if (resp.ok) {
                        const data = await resp.json();
                        if (data.status === 'PAID') {
                            // Reload once (without query params) so "My Orders" shows the paid order.
                            window.location.href = '/';
                            return;
                        }
                    }
                } catch (_) {
                    // ignore transient errors
                }

                if (attempts < maxAttempts) {
                    setTimeout(tick, 1500);
                }
            }

            setTimeout(tick, 800);
        })();

        async function checkout() {
            const checkoutButton = document.getElementById('checkout-button');
            checkoutButton.disabled = true;
            checkoutButton.textContent = demoMode ? 'Completing...' : 'Redirecting...';

            const items = [];
            document.querySelectorAll('.quantity-input').forEach((input) => {
                const productId = parseInt(input.dataset.productId, 10);
                const qty = clampInt(input.value, 0, 99);
                if (qty > 0) items.push({ product_id: productId, quantity: qty });
            });
            
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            try {
                const response = await fetch('/create-checkout-session/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({ items }),
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    alert(`Error: ${errorData.error}`);
                    checkoutButton.disabled = false;
                    checkoutButton.textContent = 'Buy';
                    return;
                }
                
                const data = await response.json();
                
                if (demoMode || data.demo) {
                    // Demo mode: auto-complete the order
                    alert('Order completed successfully! (Demo Mode)\n\nThe order has been added to "My Orders".');
                    document.querySelectorAll('.quantity-input').forEach((i) => (i.value = 0));
                    renderTotal();
                    setTimeout(() => location.reload(), 1500);
                    return;
                }
                
                // Real Stripe mode
                const { sessionId } = data;
                if (!stripe) {
                    throw new Error('Stripe is not configured on this server.');
                }
                const { error } = await stripe.redirectToCheckout({ sessionId });
                
                if (error) {
                    alert(`Error: ${error.message}`);
                    checkoutButton.disabled = false;
                    checkoutButton.textContent = 'Buy';
                }
            } catch (err) {
                alert(`Error: ${err.message}`);
                checkoutButton.disabled = false;
                checkoutButton.textContent = 'Buy';
            }
        }
    </script>
</div>
</body>
</html>
